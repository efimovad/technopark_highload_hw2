# technopark_highload_hw2
## Содержание
- [Оценка аудитории](#оценка-аудитории)
- [Оценка нагрузки](#оценка-нагрузки)
- [Выбор планируемой нагрузки](#выбор-планируемой-нагрузки)
- [Логическая схема базы данных](#логическая-схема-базы-данных)
    * [Пользователи](#пользователи)
    * [Объявления](#объявления)
    * [Сообщения](#сообщения)
- [Физическая система хранения](#физическая-система-хранения)
    * [Шардинг](#шардинг)
    * [Репликация](#репликация)
- [Выбор прочих технологий](#выбор-прочих-технологий)

<!-- toc -->
### Оценка аудитории
Авито ориентирован на Россию. Регистрация происходит по номеру телефона.  
| Население России | Проникновение интернета, 2019 | Проникновение мобильной связи, 2018 | Пользователи Avito в месяц |
|------------------|-------------------------------|-------------------------------------|----------------------------|
| 146,7 млн        | ~116 млн, 80%                 | ~256 млн, 179%                      | 32 млн                     |

Потенциальное максимальное количество аккаунтов на 2018-2019 (если на каждую сим карту - один аккаунт): 
146,7 млн * 0,8 * 1,79 = 210,1 млн

Потенциально проникновение интернета может увеличиться до 100%, но трудно прогнозировать количество сим-карт:
146,7 млн * 1,79 = 262,6 млн

Количество пользователей может увеличиться еще на 35% (1,79 - 1,79 * 0,8 = 0,35) 

### Оценка нагрузки
| Общее число посещений | Количество страниц на посещение | Время соединения |
|-----------------------|---------------------------------|------------------|
| 229,44 млн            | 12,44                           | 11 минут         |

По данным выше [[1]](https://www.similarweb.com/website/avito.ru): примерно 1 запрос от одного пользователя за минуту.
Тогда среднее rps = 229,44 млн / 60 = 3,824 млн.

| Новых объявлений в день | Новых сделок в минуту |
|-------------------------|-----------------------|
| 400000                  | 120                   |

rps = 400000 / (24 * 60 * 60) + 120 / 60 = 4.6 + 2 = 6.6

Можно заметить, что основную нагрузку на сервис составляют просмотр страниц.

### Выбор планируемой нагрузки
Так как с развитием сервиса и с увеличением проникновения интернета количество пользователей может увеличиться, а значит и увеличится количество запросов rps = 3,824 млн * 1,35 = 5,162 млн   
Также максимальная нагрузка может быть в несколько раз больше средней, необходимо ориентироваться на большее значение нагрузки.
По причинам описанным выше будем ориентироваться на нагрузку в 3 раза большую, чем средняя. Тогда rps_макс = 11,5 млн 

### Логическая схема базы данных
#### Пользователи
Таблица **пользователи**
| id  | имя | id города | телефон | ссылка на автар | тип пользователя | дата регистрации |
|-----|-----|-----------|---------|-----------------|------------------|------------------|
|bigint|varchar(30)|int|varchar(11)|varchar(100)|smallint|timestamp|

Одна строка в таблице пользователи занимает 163 байт

**Города** (для экономии памяти добавим таблицу с городами, она будет маленькой (примерно 2386 записей) относительно потенциального количества пользователей и позволит уменьшить количетво используемой памяти)
| id | название |
|----|----------|
|int|varchar(50)|

Одна строка в таблице города занимает 54 байт

#### Объявления

#####  Общие категории 
Для категорий "Личные вещи", "Животные", "Для бизнеса", "Хобби и отдых", "Бытовая электроника", "Для дома и дачи", "Услуги" 
| id     |id пользователя| название    | описание      | id категории | id подкатегории | цена | ссылка на изображение[10] | внешняя ссылка | адрес        | телефон     | почта        | id способа связи | id статуса |
|--------|-------------|---------------|--------------|-----------------|------|---------------------------|----------------|--------------|-------------|--------------|------------------|----|----|
| bigint | bigint | varchar(50) | varchar(5000) | int          | int             | int  | varchar(200)              | varchar(200)   | varchar(150) | varchar(11) | varchar(100) | shortint         | int|

Одна строка в таблице объявления (общие катеригории) занимает 7 345 байт

##### Работа
Раазмещение вакансии  
| id     | id пользователя | название    | график работы | опыт работы | описание      | зарплата | логотип      | адрес        | телефон     | почта        | id способа связи | id статуса |
|--------|-------------|---------------|-------------|---------------|----------|--------------|--------------|-------------|--------------|------------------|----|----|
| bigint | bigint | varchar(50) | shortint      | smalltint    | varchar(5000) | int      | varchar(200) | varchar(150)   | varchar(11) | varchar(100) | shortint         |int |

Одна строка в таблице вакансии (категория работа) занимает 5 549 байт

Размещение резюме
Таблица резюме
| id     | id пользователя | желаемая должность | график работы | стаж     | образование | пол  | возраст  | готов-ть к команд-кам | о себе        | зарплата | фотографии      | адрес        | телефон     | почта        | id способа связи | id статуса |
|--------|--------------------|---------------|----------|-------------|------|----------|-----------------------|---------------|----------|-----------------|--------------|-------------|--------------|------------------|-----|---|
| bigint | bigint | varchar(50)        | smalltint      | smalltint | smalltint    | bool | smalltint | smalltint              | varchar(5000) | int      | varchar(150)[5] | varchar(150) | varchar(11) | varchar(100) | smalltint         |int |

Одна строка в таблице резюме (категория работа) занимает 5 948 байт

Таблица опыт работы
| id     | id резюме | компания    | должность   | начало работы | конец работы | обязанности  |
|--------|-----------|-------------|-------------|---------------|--------------|--------------|
| bigint | bigint    | varchar(50) | varchar(50) | varchar(15)   | varchar(15)  | varchar(500) |

Одна строка в таблице опыт работы (категория работа) занимает 646 байт

Таблица учебные заведения
| id     | id резюме | название    | специальность | год окончания |
|--------|-----------|-------------|---------------|---------------|
| bigint | bigint    | varchar(50) | varchar(50)   | shortint      |

Одна строка в таблице учебные заведения (категория работа) занимает 118 байт

Таблица знание иностранных языков
| id     | id резюме | id языка | id уровень |
|--------|-----------|----------|------------|
| bigint | bigint    | smalint  | smalint    |

Одна строка в таблице знание иностранных языков занимает 20 байт

##### Недвижимость
Куплю/сниму в категории "квартира", "комната", "дома, дачи, коттеджи" и др.
| id     | id пользователя |  id недвижимости | id длит-ти | id дествия | желаемый район | id города | почта        | телефон     | id типа связи | id параметров | описание      | цена | id статуса |
|--------|-----------------|------------|------------|----------------|-----------|--------------|-------------|---------------|---------------|---------------|------|-----|----|
| bigint | bigint | smalint         | smalint    | smalint    | varchar(100)   | int       | varchar(100) | varchar(11) | smalint       | int           | varchar(5000) | int  | int |

Одна строка в таблице покупка/съем недвижимости занимает 5 251 байт

Продам/сдам в категории "квартира", "комната", "дома, дачи, коттеджи" и др.
| id     | id пользователя | id недвижимости | id дествия | вторичка | id длит-ти | адрес        | собственик | телефон     | id типа связи | номер квартиры | описание      | цена | фотографии       | внешняя ссылка | площадь |id статуса |
|--------|-----------------|------------|----------|------------|--------------|------------|-------------|---------------|----------------|---------------|------|------------------|----------------|---------|-----|----|
| bigint | bigint | smalint         | smalint    | bool     | smalint    | varchar(100) | bool       | varchar(11) | smalint       | smalint        | varchar(5000) | int  | varchar(100)[40] | varchar(500)   | int     | int |

Одна строка в таблице покупка недвижимости занимает 9 651 байт

#### Сообщения
| id     | id отправителя | id получателя | дата отправления | сообщение     |
|--------|----------------|---------------|------------------|---------------|
| bigint | bigint         | bigint        | time             | varchar(5000) |

Одна строка в таблице сообщения занимает 5032 байт

#### Транзакции
Отдельная таблица транзакции существует для каждой категории
| id     | id продавца | id покупателя | id действия | цена | статус |
|--------|-------------|---------------|-------------|------|--------|
| bigint | bigint      | bigint        | bigint      | int  | int    |

Одна строка в таблице транзакции занимает 40 байт

### Физическая система хранения
#### Шардинг
##### Пользователи
В веб-сервисе Авито нет функции просмотра всех пользователей или поиска пользователей. Данные о пользователе могут понадобиться нам для вывода всех объявлений одного пользователя и переписки с пользователем, поэтому мы можем вынести таблицу пользователей на отдельный сервер. В обоих случаях поиск пользователя осуществляется по id в шардинге нет необходимости, если таблица помещается на одном сервере. 

##### Объявления
**Текущее количество объявлений:** 60 693 348
Единстенная функция, которая выводит разные категории товаров - это рекомендации. Эта функция не предполагает вычисления в режиме реального времени, и может быть предвычислена, поэтому отдельные категории можно вынести на отдельные сервисы (т.е. отдельные базы для каждой категории), но категории "личные вещи" и "транспорт" все еще слишком большие (40.7% и 20.4% от общего числа объявлений), следовательно их необходимо как-то делить.
![распределение объявлений по категориям](https://sun9-29.userapi.com/c853516/v853516521/2177ae/zSgrvhTuqE8.jpg)

Также на картинке ниже видно, что практически четверть объявлений приходится на Москву и МО. На Питер и ЛО - 9.3 % объявлений. На остальные крупнейшие города приходится около 1 млн объявлений (примерно 1.7%).
![распрделение объявлений по городам](https://sun9-70.userapi.com/c857024/v857024392/c7e79/DvMRj0-1CFc.jpg)

По выше перечиcленным причинам, для бд сервисов категорий "транспорт", "личные вещи", "для дома и дачи" можно реализовать шардинг по расположению (категория - Москва, категория - МО и т.д.), т.к. обычно пользователи ищут товары по конкретным городам. Тогда для Москвы количество объявлений в категории "личные вещи" количество объявлений все еще достаточно велико (около 6 млн), поэтому большие города стоит дополнительно разбивать по районам (в городах с метро можно разбивать по станциям с метро категория - Москва-Охотный ряд, Москва-Курская... Санкт-Петербург-Академическая). Тогда в самой большой большой категории личные-вещи-москва среднее число объявлений в таблице 6 млн / 275 (количество станций метро) = 22 тыс.

#### Репликация
Необходимо обеспечить отказоустойчивость бд и снизить нагрузку на сервера. Как мы поняли в пункте "Оценка нагрузки", основная нагрузка - это выгрузка данных из таблиц, а не добавление новых данных. Это значит, что нам отлично подходит master-slave репликация, которая позволяет считывать данные из нескольких источников. 

Выбирая между MySQL и postgres, выберем последнее, т.к. обе СУБД имею примерно одинаковую производительность, но репликация postgres эффективнее, и в целом postgres имеет больший функционал.
[1 - MySQL vs PostgreSQL](https://habr.com/ru/company/mailru/blog/248845/)  
[2 - Виды репликаций](https://ruhighload.com/%D0%A0%D0%B5%D0%BF%D0%BB%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D1%8F+%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D1%85)  

#### Подсчет количества данных
##### Объявления
| общие категории | недвижимость    | работа             | транспорт |
|-----------------|-----------------|--------------------|-----------|
| 7.17 Кбайт      | 5.13/9.65 Кбайт | 5.42/5.81(*) Кбайт |  (?)      |

Выберем самую большую категорию "личные вещи". В ней сейчас 41% объявлений, т.е. около 25 млн объявлений, которые занимают 169 Гбайт. Каждый день появляется примерно 400 тыс объявлений, 
тогда количество новых **объявлений за год**: 
400 тыс * 365 * 0.407 = 59 422 000 (406 Гбайт данных);
а количество **сделок за год** для этой категории: 
120 * 60 * 24 * 365 * 0.407 = 63 072 000.
В категории "личные вещи" обычно продаются вещи в единичном экземпляре, это значит, что  тогда нет необходимости хранить всю информацию о закрытом объявлении . Возможным решением проблемы является вынесение основной информации в отдельную таблицу.

Таблица объявлений с основной информацией, позволит уменьшить размер хранимых данных после закрытия.  
| id     | id пользователя | название    | id города | цена | дата      | аватар       | статус   | id категории |
|--------|-----------------|-------------|-----------|------|-----------|--------------|----------|--------------|
| bigint | bigint          | varchar(50) | bigint    | int  | timestamp | varchar(100) | smallint |int           |

Одна строка в сокращенной таблице объявлений 192 байт, что составляет примерно 2.5% от исходного размера.

|id|описание|ссылка на изображение[10]|внешняя ссылка|адрес|телефон|почта|id способа связи |
|--|--------|-------------------------|--------------|-----|-------|-----|-----------------|
|bigint|varchar(5000)|varchar(100)[10]|varchar(200)|varchar(150)|varchar(11)|varchar(100)|shortint|
Проблема дубликатов!

### Выбор прочих технологий 
Для разработки фронтенда будем использовать JavaScript/TypeScript. Для разработки бекенда выберем Go как основной язык для разработки, он отлично подходит для написания серверов, т.к. имеет следующие преимущества:
1. быстрая разработка (простой синтаксис)
2. эффективная обработка параллелизма
3. высокая производительность

Поиск по объявлениям должен быть более гибким: ключевые слова должны находиться как в заголовке, так и в описании, а также в другом падеже. Для этой цели в postgres можно интегрировать sphinx c помощью плагина pg-sphinx или  elasticsearch с помощью zombodb.
1. sphinx - все данные на одном сервере
2. elasticsearch - кластер 

ВЫБРАТЬ

Еще на этапе "Логическая схема базы данных" было понятно, что необходимо использовать микросервисную архитектуру. Сервисы должны быть максимально изолированы, но в случае необходимости взаимодействия сервисов будем использовать протокол gRPC (например, сервис рекомендаций может обращаться к сервисам разных категорий). Протокол gRPC удобен тем, что:
1. можно использовать с разными языками программирования
2. запрос можно отменить на клиенте и на сервере
3. генерация кода клиента

Для того, чтобы объединить все микросервисы в качестве API Gateway будем использовать nginx. Благодаря своей архитектуре nginx способен поддерживать большое количество соединений и нужен для балансировки нагрузки особенно при большом количестве "медленных" соеднинений.

Наша система состоит из множества компонентов, поэтому для быстрого обнаружения багов стоит использовать CI/CD подход. Для этого удобно использовать Gitlab CI/CD.  

Дополнительно для очерей задач будем использовать Redis.
языки программирования, фреймфорки, протоколы взаимодействия, веб-вервера и т.д. (с обоcнованием выбора)
### Расчет нагрузки и потребного оборудования

### Выбор хостинга / облачного провайдера и расположения серверов
### Схема балансировки нагрузки 
(входящего трафика и внутрипроектного, терминация SSL)
### Обеспечение отказоустойчивости
