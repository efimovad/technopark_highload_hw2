# technopark_highload_hw2
## Содержание
- [Оценка аудитории](#оценка-аудитории)
- [Оценка нагрузки](#оценка-нагрузки)
- [Выбор планируемой нагрузки](#выбор-планируемой-нагрузки)
- [Логическая схема базы данных](#логическая-схема-базы-данных)
    * [Пользователи](#пользователи)
    * [Объявления](#объявления)
    * [Сообщения](#сообщения)
- [Физическая система хранения](#физическая-система-хранения)
    * [Шардинг](#шардинг)
    * [Репликация](#репликация)
- [Выбор прочих технологий](#выбор-прочих-технологий)
- [Расчет нагрузки и потребного оборудования](#расчет-нагрузки-и-потребного-оборудования)
- [Выбор хостинга и расположения серверов](#выбор-хостинга-и-расположения-серверов)
- [Схема балансировки нагрузки](#схема-балансировки-нагрузки)
- [Обеспечение отказоустойчивости](#обеспечение-отказоустойчивости)

<!-- toc -->
### Оценка аудитории
Авито ориентирован на Россию. Регистрация происходит по номеру телефона.  
| Население России | Проникновение интернета, 2019 | Проникновение мобильной связи, 2018 | Пользователи Avito в месяц |
|------------------|-------------------------------|-------------------------------------|----------------------------|
| 146,7 млн        | ~116 млн, 80%                 | ~256 млн, 179%                      | 32 млн                     |

Потенциальное максимальное количество аккаунтов на 2018-2019 (если на каждую сим карту - один аккаунт): 
146,7 млн * 0,8 * 1,79 = 210,1 млн

Потенциально проникновение интернета может увеличиться до 100%, но трудно прогнозировать количество сим-карт:
146,7 млн * 1,79 = 262,6 млн

Количество пользователей может увеличиться еще на 35% (1,79 - 1,79 * 0,8 = 0,35) 

Всего у Авито около примерно 89 млн пользователей [[1]](https://radar.yandex.ru/top_list?type=classified).

### Оценка нагрузки
Основные дейсвия на сайте:
- список объявлений по расположению, по категории
- поиск по ключевым словам
- получить подробную информацию по объявлению
- получить все объявления конкретного пользователя
- создать объявление
- редактировать объявление (в том числе изменение статуса)
- удаление объявления
- получить личную информацию профиля 
- редактировать информацию профиля
- отправить сообщение
- получить последние сообщения
- оставить отзыв о продавце  

| Общее число посещений | Количество страниц на посещение | Время соединения |
|-----------------------|---------------------------------|------------------|
| 229,44 млн            | 12,44                           | 11 минут         |

По данным выше общее среднее rps = 229,44 млн * 11 / (7 * 24 * 60 * 60) = 4173

| Новых объявлений в день | Новых сделок в минуту |
|-------------------------|-----------------------|
| 400000                  | 120                   |

rps_добавление_объявления = 400000 / (24 * 60 * 60) = 4.6
Заключение сделки = закрытие объявления + отзыв  
rps_закрытие_объявления = 120 / 60 = 2  
rps_отзыв = 120 / 60 = 2  

| просмотр раздела  | просмотры/мес | rps  |
|-------------------|---------------|------|
| услуги            | 980 млн       | 372  |
| недвижимость      | 1.2 млрд      | 456  |
| товары            | 2.6 млрд      | 987  |
| транспорт         | 2.2 млрд      | 835  |
| вакансии и резюме | 531 млн       | 202  |
| все               | 7.5 млрд      | 2852 |

Можно заметить, что основную нагрузку на сервис составляют просмотр страниц и действия с объявлениями.Т.к.эти действия не требуют дополнительной информации о пользователях, имеет смысл реализовать микросервисный подход, со следующими отдельными микросервисами:
* объявлений:
    - список объявлений по расположению, по категории
    - поиск по ключевым словам
    - получить подробную информацию по объявлению
    - получить все объявления конкретного пользователя
    - создать объявление
    - редактировать объявление (в том числе изменение статуса)
    - удаление объявления
* пользователей:
    - регистрация
    - авторизация
    - получить личную информацию профиля 
    - редактировать информацию профиля
    - оставить отзыв о пользователе
* чатов:
    - отправить сообщение
    - получить последние сообщения

Общая нагрузка составляет примерно 4173 rps, из которых примерно 3000 rps работа с объявлениями, пусть нагрузки на оставшиеся микросервисы составляют 600 rps на каждый.

### Выбор планируемой нагрузки
Так как с развитием сервиса и с увеличением проникновения интернета количество пользователей может увеличиться, а значит и увеличится количество запросов. Также максимальная нагрузка может быть в несколько раз больше средней, необходимо ориентироваться на большее значение нагрузки. По данным причинам будем ориентироваться на нагрузку примерно в 2 раза большую, чем средняя. Тогда выберем нагрузку на каждый микросервис:
* объявления - 6000 rps  
* пользователи - 1000 rps  
* чаты - 1000 rps  

### Логическая схема базы данных
#### Пользователи

Таблица **пользователи**  
| id  | имя | id города | телефон | ссылка на автар | тип пользователя | дата регистрации |хеш пароля|
|-----|-----|-----------|---------|-----------------|------------------|------------------|----|
|bigint|varchar(30)|int|varchar(11)|varchar(100)|smallint|timestamp|varchar(32)|

Одна строка в таблице пользователи занимает 195 байт

**Города** (для экономии памяти добавим таблицу с городами, она будет маленькой (примерно 2386 записей) относительно потенциального количества пользователей и позволит уменьшить количетво используемой памяти)
| id | название |
|----|----------|
|int|varchar(50)|

Одна строка в таблице города занимает 54 байт

#### Объявления
Основные запросы к бд:
    - список объявлений по расположению, по категории
    - поиск по ключевым словам
    - получить подробную информацию по объявлению
    - получить все объявления конкретного пользователя
    - создать объявление
    - редактировать объявление (в том числе изменение статуса)
    - удаление объявления

#####  Общие категории 
Для категорий "Личные вещи", "Животные", "Для бизнеса", "Хобби и отдых", "Бытовая электроника", "Для дома и дачи", "Услуги" 
| id     |id пользователя| название    | описание      | id категории | id подкатегории | цена | ссылка на изображение[10] | внешняя ссылка | адрес        | телефон     | почта        | id способа связи | id статуса |
|--------|-------------|---------------|--------------|-----------------|------|---------------------------|----------------|--------------|-------------|--------------|------------------|----|----|
| bigint | bigint | varchar(50) | varchar(5000) | int          | int             | int  | varchar(200)              | varchar(200)   | varchar(150) | varchar(11) | varchar(100) | shortint         | int|

Одна строка в таблице объявления (общие катеригории) занимает 7 345 байт

##### Работа
Раазмещение вакансии  
| id     | id пользователя | название    | график работы | опыт работы | описание      | зарплата | логотип      | адрес        | телефон     | почта        | id способа связи | id статуса |
|--------|-------------|---------------|-------------|---------------|----------|--------------|--------------|-------------|--------------|------------------|----|----|
| bigint | bigint | varchar(50) | shortint      | smalltint    | varchar(5000) | int      | varchar(200) | varchar(150)   | varchar(11) | varchar(100) | shortint         |int |

Одна строка в таблице вакансии (категория работа) занимает 5 549 байт

Размещение резюме
Таблица резюме
| id     | id пользователя | желаемая должность | график работы | стаж     | образование | пол  | возраст  | готов-ть к команд-кам | о себе        | зарплата | фотографии      | адрес        | телефон     | почта        | id способа связи | id статуса |
|--------|--------------------|---------------|----------|-------------|------|----------|-----------------------|---------------|----------|-----------------|--------------|-------------|--------------|------------------|-----|---|
| bigint | bigint | varchar(50)        | smalltint      | smalltint | smalltint    | bool | smalltint | smalltint              | varchar(5000) | int      | varchar(150)[5] | varchar(150) | varchar(11) | varchar(100) | smalltint         |int |

Одна строка в таблице резюме (категория работа) занимает 5 948 байт

Таблица опыт работы
| id     | id резюме | компания    | должность   | начало работы | конец работы | обязанности  |
|--------|-----------|-------------|-------------|---------------|--------------|--------------|
| bigint | bigint    | varchar(50) | varchar(50) | varchar(15)   | varchar(15)  | varchar(500) |

Одна строка в таблице опыт работы (категория работа) занимает 646 байт

Таблица учебные заведения
| id     | id резюме | название    | специальность | год окончания |
|--------|-----------|-------------|---------------|---------------|
| bigint | bigint    | varchar(50) | varchar(50)   | shortint      |

Одна строка в таблице учебные заведения (категория работа) занимает 118 байт

Таблица знание иностранных языков
| id     | id резюме | id языка | id уровень |
|--------|-----------|----------|------------|
| bigint | bigint    | smalint  | smalint    |

Одна строка в таблице знание иностранных языков занимает 20 байт

##### Недвижимость
Куплю/сниму в категории "квартира", "комната", "дома, дачи, коттеджи" и др.
| id     | id пользователя |  id недвижимости | id длит-ти | id дествия | желаемый район | id города | почта        | телефон     | id типа связи | id параметров | описание      | цена | id статуса |
|--------|-----------------|------------|------------|----------------|-----------|--------------|-------------|---------------|---------------|---------------|------|-----|----|
| bigint | bigint | smalint         | smalint    | smalint    | varchar(100)   | int       | varchar(100) | varchar(11) | smalint       | int           | varchar(5000) | int  | int |

Одна строка в таблице покупка/съем недвижимости занимает 5 251 байт

Продам/сдам в категории "квартира", "комната", "дома, дачи, коттеджи" и др.
| id     | id пользователя | id недвижимости | id дествия | вторичка | id длит-ти | адрес        | собственик | телефон     | id типа связи | номер квартиры | описание      | цена | фотографии       | внешняя ссылка | площадь |id статуса |
|--------|-----------------|------------|----------|------------|--------------|------------|-------------|---------------|----------------|---------------|------|------------------|----------------|---------|-----|----|
| bigint | bigint | smalint         | smalint    | bool     | smalint    | varchar(100) | bool       | varchar(11) | smalint       | smalint        | varchar(5000) | int  | varchar(100)[40] | varchar(500)   | int     | int |

Одна строка в таблице покупка недвижимости занимает 9 651 байт

#### Сообщения  
Основные запросы к бд:  
- отправить сообщение  
- получить последние сообщения  

| id     | id отправителя | id получателя | дата отправления | сообщение     |
|--------|----------------|---------------|------------------|---------------|
| bigint | bigint         | bigint        | time             | varchar(500) |

Одна строка в таблице сообщения занимает 532 байт

### Физическая система хранения
#### Шардинг
##### Пользователи
В веб-сервисе Авито нет функции просмотра всех пользователей или поиска пользователей. Данные о пользователе могут понадобиться нам для вывода всех объявлений одного пользователя и переписки с пользователем. Это значит, что нет необходимости делать JOIN по таблице users, поэтому мы можем вынести таблицу пользователей на отдельный сервер. В обоих случаях поиск пользователя осуществляется по id в дополнительном шардинге нет необходимости, если таблица помещается на одном сервере. 
Информация об одном пользователе повещается в 195 байт, это значит, что все пользователи занимают 88744650 * 195 байт = 16 Гбайт. Это значит, что все пользователи поместятся на один шард. Также на нашем сервисе не предполагается поиска по пользователям и пользователя всегда получают по id, поэтому для хранения нам достаточно будет использовать любую реляционную бд без каких-либо поисковых движков.

##### Объявления
**Текущее количество объявлений:** 60 693 348
Единстенная функция, которая выводит разные категории товаров - это рекомендации. Эта функция не предполагает вычисления в режиме реального времени, и может быть предвычислена, поэтому можно использовать горизонтальное шардирование по типу категории, но как "личные вещи" и "транспорт" все еще содержат очень большое количество записей (40.7% и 20.4% от общего числа объявлений), следовательно такого индексирования недостаточно  
![распределение объявлений по категориям](https://sun9-29.userapi.com/c853516/v853516521/2177ae/zSgrvhTuqE8.jpg)

Также на картинке ниже видно, что практически четверть объявлений приходится на Москву и МО. На Питер и ЛО - 9.3 % объявлений. На остальные крупнейшие города приходится около 1 млн объявлений (примерно 1.7%).
![распрделение объявлений по городам](https://sun9-70.userapi.com/c857024/v857024392/c7e79/DvMRj0-1CFc.jpg)

По выше перечиcленным причинам, для бд сервисов категорий "транспорт", "личные вещи", "для дома и дачи" стоит реализовать шардинг по расположению (категория - Москва, категория - МО и т.д.), т.к. обычно пользователи ищут товары по конкретным городам. Тогда для Москвы количество объявлений в категории "личные вещи" количество объявлений все еще достаточно велико (около 6 млн), поэтому большие города стоит дополнительно разбивать по районам (в городах с метро стоит разбивать по станциям с метро категория - Москва-Охотный ряд, Москва-Курская... Санкт-Петербург-Академическая). Тогда в самой большой большой категории личные-вещи-москва среднее число объявлений в таблице 6 млн / 275 (количество станций метро) = 22 тыс.

Попытаемся вычислить прирост данных за год:
| общие категории | недвижимость    | работа             | транспорт |
|-----------------|-----------------|--------------------|-----------|
| 7.17 Кбайт      | 5.13/9.65 Кбайт | 5.42/5.81(*) Кбайт | 8 Кбайт   |

Выберем самую большую категорию "личные вещи". В ней сейчас 41% объявлений, т.е. около 25 млн объявлений, которые занимают 169 Гбайт. 
Все объявления вместе занимают 564 Гбайт. Каждый день появляется примерно 400 тыс объявлений, 
тогда количество новых **объявлений за год**: 
400 тыс * 365 * 0.407 = 146 000 000 (около 1 Тбайта данных);
а количество **сделок за год** : 
120 * 60 * 24 * 365 * 0.407 = 154 968 059.
 С рук обычно продаются вещи в единичном экземпляре, это значит, что  тогда нет необходимости хранить всю информацию о закрытом объявлении. Возможным решением проблемы является сохранения только основной информации после закрытия объявления (см. таблицу ниже). 

Таблица объявлений с основной информацией, позволит уменьшить размер хранимых данных после закрытия.  
| id     | id пользователя | название    | id города | цена | дата      | аватар       | статус   | id категории |
|--------|-----------------|-------------|-----------|------|-----------|--------------|----------|--------------|
| bigint | bigint          | varchar(50) | bigint    | int  | timestamp | varchar(100) | smallint |int           |

Сокращенный формат данных объявлений составляет 192 байт, что составляет примерно 2.5% от исходного размера. По данным выше видно, что количество новых объявлений примерно равно количеству сделок, поэтому прирост данных за год будет примерно 1 Тбайт * 0.025 = 25 Гбайт

##### Чаты
В первую очередь сервис ориентирован на работу с объявлениями, поэтому поиск по сообщениям осуществлять не требуется. Также на сайте есть номер продавца, поэтому часть пользователей связываются не через чат. По объему сообщений не имеется определенной статистики, поэтому попытаемся предположить объем:
- в среднем для заключения сделки требуется 5 сообщений
- объем одного сообщения 532 байта
- допустим половина пользователей связыватеся с продавцом по телефону
Из этих предположений среднее количество данных о сообщениях за год: 
120 сделок/мин * 0.5 * 60 * 24 *365 * 5 сообщений * 532 байта / (1024 * 1024 * 1024) = 125 Гбайт
Максимальный размер postgres составляет 64 Тбайта, что значит, что мы можем использовать данную СУБД.

#### Выводы
Для хранения данных о пользователях и сообщений пользователей, выбирая между MySQL и postgres, выберем последнее, т.к. обе СУБД имею примерно одинаковую производительность, но репликация postgres эффективнее, и в целом postgres имеет больший функционал. 

На основе исследований [4](https://www.percona.com/blog/2017/01/06/millions-queries-per-second-postgresql-and-mysql-peaceful-battle-at-modern-demanding-workloads/) один клиент может делать примерно 1000 qps, что не дает запаса по нагрузке для нагрузки микросервиса 1000 rps. Также часть запросов требует авторизации (среднее частота этих запросов не превышает 100-500), поэтому для "пользователей" ниже будем создавать 1 дополнительную репликацию.

Объявления - являются основным контентом Авито, для разных категорий хранится разная структура данных, поэтому нам удобно использовать schemaless-sql, например MongoDB:  
- поддерживает шардинг   
- репликацию  
- также имеет поддержку Apache Lucene для оптимизации поиска  
- максимальный размер 32 Тбайта (размер всех существующих объявлений 565 Гбайт)  
   
На основе исследований [5](http://smalldatum.blogspot.com/2014/04/concurrent-read-only-not-cached-mongodb.html) на 8 ядрах обеспечивается 15000 qps, но реально qps может быть на порядок меньше (1500), чего недостаточно для 6000 rps микросервиса (ниже в обеспечении отказоустойчивости решается эта проблема)

[1 - MySQL vs PostgreSQL](https://habr.com/ru/company/mailru/blog/248845/)  
[2 - Виды репликаций](https://ruhighload.com/%D0%A0%D0%B5%D0%BF%D0%BB%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D1%8F+%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D1%85)  
[3 - Сравнение бд по qps (1)](https://www.arangodb.com/2015/10/benchmark-postgresql-mongodb-arangodb/)  
[4 - Сравнение бд по qps (2)](https://www.percona.com/blog/2017/01/06/millions-queries-per-second-postgresql-and-mysql-peaceful-battle-at-modern-demanding-workloads/)  
[5 - Cравнение бд по qps (3)](http://smalldatum.blogspot.com/2014/04/concurrent-read-only-not-cached-mongodb.html)  

### Выбор прочих технологий 
Отметим еще раз, что для хранения данных мы будем использовать postgres (пользователи и сообщения) и mongodb (объявления). Т.к. нам необходим быстрый поиск по объявлениям будем использовать технологию MongoDB Atlas Full-Text Search, которая основана на Apache Lucene. 

Для разработки фронтенда будем использовать JavaScript/TypeScript. Для разработки бекенда выберем Go как основной язык для разработки, он отлично подходит для написания серверов, т.к. имеет следующие преимущества:
1. быстрая разработка (простой синтаксис)
2. эффективная обработка параллелизма
3. высокая производительность
4. имеет интеграцию с выбранными субд

Еще на ранних этапах проектирования было понятно, что необходимо использовать микросервисную архитектуру. Сервисы должны быть максимально изолированы, но в случае необходимости взаимодействия сервисов будем использовать протокол gRPC (например, сервис рекомендаций может обращаться к сервисам разных категорий). Протокол gRPC удобен тем, что:
1. можно использовать с разными языками программирования (в том числе в выбранным Go)
2. запрос можно отменить на клиенте и на сервере
3. генерация кода клиента

Для того, чтобы объединить все микросервисы в качестве API Gateway будем использовать nginx. Благодаря своей архитектуре nginx способен поддерживать большое количество соединений и нужен для балансировки нагрузки особенно при большом количестве "медленных" соеднинений.

Наша система состоит из множества компонентов, поэтому для быстрого обнаружения багов стоит использовать CI/CD подход. Для этого удобно использовать Gitlab CI/CD.  

### Расчет нагрузки и потребного оборудования
Ниже представлена таблица максимальный rps и занимаемое количество памяти для существующих данных.
| микросервис  | rps_макс | память   | размер бд |
|--------------|----------|----------|-----------|
| объявления   | 6000     | 406 Гбайт | 32 Тбайта |
| пользователи | 1000     | 16 Гбайт  | 64 Тбайта |
| сообщения    | 1000     | 125 Гбайт | 64 Тбайта |

Сервис с самой большой нагрузкой - это **сервис объявлений**. По сценарию пользователь имеет следующий функционал (будем считать, что простые функции обеспечивают 1000 rps, а сложные 100 rps):
    - список объявлений по категории                100 rps
    - поиск по ключевым словам                      100 rps
    - получить информацию по объявлению             1000 rps
    - получить все объявления по id пользователя    100 rps
    - создать объявление                            1000 rps
    - редактировать объявление                      1000 rps
    - удаление объявления                           1000 rps
    
Таким образом одно ядро в среднем обеспечивает (1000 * 4 + 100 * 3) / 7 = 614 rps, тогда чтобы обеспечить выбранную нами нагрузку потребуется 10 ядер (16), но для двух кратного запаса будем использовать 2 таких машины: 
| CPU(cores) | RAM(GB) | SSD(GB) | кол-во | 
|------------|---------|---------|--------|
| 8          | 32      | 2048    | 2      |
  
При открытии **чата** осуществляется загрузка списка 20 прошлых сообщений, также есть возможность отправить сообщение: 
- отправить сообщение               1000 rps  
- получить последние сообщения      100 rps

Таким образом одно ядро в среднем обеспечивает 550 rps => требуется 4 ядра
| CPU(cores) | RAM(GB) | SSD(GB) |
|------------|---------|---------|
| 4          | 32      | 1024    |
  
Основной функционал микросервиса **пользователи** :
    - регистрация                               1000 rps
    - авторизация                               1000 rps
    - получить личную информацию профиля        1000 rps 
    - редактировать информацию профиля          1000 rps
    - оставить отзыв о пользователе             1000 rps
    
Таким образом одно ядро в среднем обеспечивает 1000 rps, что соответствует выбранной нагрузке, но для 2-х кратного запаса возьмем 2 ядра:     
| CPU(cores) | RAM(GB) | SSD(GB) |
|------------|---------|---------|
| 2          | 16      | 1024    |
  
Для фронтенда выбремем следующую конфигурацию:
| CPU(cores) | RAM(GB) | SSD(GB) |
|------------|---------|---------|
| 14         | 32      | 1024    |

### Выбор хостинга и расположения серверов
В первую очередь Авито ориентирован на Россию, поэтому логично расположить сервера в России. При покупке облачных серверов нет необходимости в аппаратной поддержке. Также сервис не требует много железа, поэтому цена не сильно важна и мы выберем Яндекс Облако, т.к. он обеспечивает весь нужный функционал.  
Дополнительно для хостинга картинок будем использовать хостинг https://www.keycdn.com/ , потому что есть сервера в Европе и в нем поместятся все наши изображения (около 1000 Тбайт). 

### Схема балансировки нагрузки 
Как было упомянуто выше будем использовать nginx для балансировки нагрузки с использвоанием схемы L7. Это позволит равномерно распределить нагрузку и решит проблемы медленных клиентов. Также nginx имеет внутренние инструменты для настройки SSL терминации. 

### Обеспечение отказоустойчивости
Необходимо обеспечить отказоустойчивость бд и снизить нагрузку на сервера. Как мы поняли в пункте "Оценка нагрузки", основная нагрузка - это выгрузка данных из таблиц, а не добавление новых данных. Это значит, что нам отлично подходит master-slave репликация, которая позволяет считывать данные из нескольких источников. Тогда для каждой базы данных "пользователи", "объявления" и "сообщения" будем создавать репликацию master-slave, инструменты для этого есть и в postgres, и в MongoDB. Т.к. на этапе выбора бд было выяснено, что postgres выдерживает выбранную нагрузку для сообщений и пользователей, поэтому будет достаточно 1 репликации на каждую таблицу. Для обеспечения qps для "объявлений" необходимо дополнительно 3 репликации (6000 qps / 1500 qps - 1). 

